#!/usr/bin/perl -w

use 5.012;
use CGI;
use URI::Escape;
use Carp; 
my $cgi = new CGI;
use utf8; 
use HTML::Entities;
use Net::Tshark;
print "Content-Type: text/html \n\n";  
use CGI::Carp qw(fatalsToBrowser); 
use IO::Socket::INET;
 

use constant false => 0;
use constant true  => 1;

my $param = $cgi->{param};

my $Interface = $cgi->param('Interface');

my $tsharkOfset = $cgi->param('tsharkOfset');

my $tsharkC = $cgi->param('tsharkC');
my $tsharkCText = $cgi->param('tsharkCText');

my $tsharkPcap = $cgi->param('tsharkPcap');

my $tsharkPcapng = $cgi->param('tsharkPcapng');

my $total = $cgi->param('total');

my $filter = $cgi->param('filter');

my $value;
my $Options ;

if ($Interface!="")
{
$Options = $Options . " -i $Interface";
}


if ($tsharkOfset eq 'true') 
{
$Options = $Options . " -s 120";
}


if ($tsharkC eq 'true') 
{
$Options = $Options . " -c $tsharkCText";
}



if ($tsharkPcapng eq 'true') 
{
$Options = $Options . " -F pcapng";
}
else
{
$Options = $Options . " -F pcap";
}

$Options = $Options . " $filter";

#exec "sudo ping www.google.fr >>auuy" unless fork

#print OUT $value;

#print OUT "here is my output\n";
#print $out "here is more output\n";

#$value = qx(ping -c 4 www.google.fr);
#print $val;

#system("tshark $Options >> out2");

#system("ping www.google.fr >> out2");

# initialize host and port
my $filename = 'pid.txt';
#open(my $fh, '>', $filename) or die "Could not open file '$filename' $!";
#print $fh $$;
#print $$;


my $socket;
my $serverdata;
my $clientdata;

$socket = new IO::Socket::INET (
  PeerHost => '127.0.0.1',
  PeerPort => '0258',
  Proto => 'tcp',
) or die "$!\n";



# Send some message to server.
print $socket "$Options";

$socket->close();

$cgi->header('text/plain;charset=UTF-8');

